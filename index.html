<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Annotation Tool</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }

        /* Custom styles for PDF.js text layer and viewer */
        .pdfViewer {
            width: 100%;
            height: 100%;
            overflow-y: auto;
            background: #f0f0f5;
        }

        .page {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            margin: 10px auto;
            position: relative;
            background-color: white;
            border-radius: 6px;
        }

        /* PDF.js Text Layer styling is crucial for selection */
        .textLayer {
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            color: transparent; /* Makes text invisible, but selectable */
            overflow: hidden;
            line-height: 1.0; /* Must match the CSS used during PDF rendering */
            z-index: 10; /* Ensures it sits above the canvas */
        }

        .textLayer span {
            position: absolute;
            white-space: pre;
            cursor: text;
            transform-origin: 0% 0%;
        }

        /* Layer for highlights placed between canvas and text layer */
        .highlightLayer {
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            z-index: 7; /* below textLayer, above canvas */
            pointer-events: none;
        }

        .highlightBox {
            position: absolute;
            background: rgba(250, 204, 21, 0.35); /* amber-400 @ 35% */
            border-radius: 2px;
            box-shadow: 0 0 0 1px rgba(250, 204, 21, 0.25) inset;
            mix-blend-mode: multiply;
        }
        
        /* The comment highlight style */
        .comment-highlight {
            background-color: #fcd34d; /* Amber-300 */
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.2s;
        }

        .comment-text {
            font-style: italic;
            color: #4b5563; /* Gray-600 */
            border-left: 3px solid #f59e0b; /* Amber-500 */
            padding-left: 10px;
            white-space: pre-wrap; /* Preserve formatting */
            font-size: 0.875rem; /* text-sm */
        }

        .reply-list li {
            font-size: 0.875rem;
            color: #374151; /* Gray-700 */
            padding-left: 8px;
            border-left: 2px solid #9ca3af; /* Gray-400 */
            margin-top: 4px;
        }

        /* Responsive layout tweaks */
        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Drag & drop visual cue */
        .drop-active {
            outline: 3px dashed #6366f1; /* indigo-500 */
            outline-offset: -8px;
            background: #eef2ff; /* indigo-100 */
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <header class="bg-indigo-700 text-white shadow-lg p-4 sticky top-0 z-20">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">PDF Annotator</h1>
            <label for="pdf-file" class="cursor-pointer bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                Upload PDF
                <input type="file" id="pdf-file" accept="application/pdf" class="hidden" onchange="handleFileSelect(event)">
            </label>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 lg:p-6 h-[calc(100vh-6rem)] relative">
        
        <div id="loader" class="text-center p-8 text-gray-500 hidden">
            <svg class="animate-spin h-8 w-8 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-2">Loading PDF...</p>
        </div>

        <div id="app-container" class="main-grid grid lg:grid-cols-3 gap-6 h-full">
            
            <!-- PDF Viewer Column (Left) -->
            <div class="lg:col-span-2 bg-white rounded-xl shadow-xl overflow-hidden">
                <div class="h-full pdfViewer" id="pdf-container">
                    <p class="text-center text-gray-400 p-20">Please upload a PDF file to begin.</p>
                </div>
            </div>

            <!-- Comments/Annotation Column (Right) -->
            <div class="lg:col-span-1 flex flex-col h-full">
                <div class="bg-white rounded-xl shadow-xl p-4 flex flex-col flex-grow">
                    
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h2 class="text-xl font-bold text-gray-700">Annotations List</h2>
                        <button
                            id="export-all-btn"
                            onclick="exportAllComments()"
                            class="flex items-center space-x-1 text-sm bg-indigo-500 hover:bg-indigo-600 text-white py-1 px-3 rounded-lg font-semibold transition duration-150 shadow-md disabled:opacity-50"
                            disabled
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M4 4a2 2 0 012-2h5l4 4v8a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" />
                                <path d="M8 2v4h4" />
                            </svg>
                            <span>Copy to Clipboard</span>
                        </button>
                    </div>
                    
                    <!-- Display Area for Saved Comments -->
                    <div id="comments-list" class="flex-grow overflow-y-auto space-y-4">
                        <p id="no-comments" class="text-gray-400 italic text-sm">No annotations added yet. Select text in the PDF to start annotating.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Floating Action Menu for Annotation -->
        <div id="floating-menu" class="fixed hidden bg-indigo-600 shadow-xl rounded-lg p-1 z-30 transform -translate-x-1/2 -translate-y-full" style="position: absolute; top:0; left:0; pointer-events: none;">
            <button id="annotate-float-btn" onclick="triggerAnnotation()" class="text-white text-xs font-semibold py-1 px-3 rounded-md hover:bg-indigo-700 transition duration-150 flex items-center pointer-events-auto">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                Add Comment
            </button>
        </div>
    </main>
    
    <!-- Custom Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300">
            <h3 class="text-lg font-bold text-red-600 mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M8.257 3.341a1 1 0 00.894 0L14.78 6.57A1 1 0 0015 7.43v5.14a1 1 0 00-.22.61l-5.656 3.77A1 1 0 009 16.29V3.71a1 1 0 01.257-.37zM4.757 6.662a1 1 0 01.446.732l.006.183v5.14a1 1 0 01-.446.732l-3.224 2.149a.5.5 0 01-.75-.43v-5.14a1 1 0 01.446-.732l3.224-2.149z" clip-rule="evenodd" />
                </svg>
                Confirm Deletion
            </h3>
            <p id="modal-message" class="text-gray-700 mb-6">Are you sure you want to delete this item?</p>
            <div class="flex justify-end space-x-3">
                <button onclick="hideModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-semibold">Delete</button>
            </div>
        </div>
    </div>

    <!-- Load PDF.js and split app scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="assets/js/globals.js"></script>
    <script src="assets/js/ui-utils.js"></script>
    <script src="assets/js/pdf-viewer.js"></script>
    <script src="assets/js/selection.js"></script>
    <script src="assets/js/annotations.js"></script>
</body>
</html>
