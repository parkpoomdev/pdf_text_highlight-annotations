<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Annotation Tool</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }

        /* Custom styles for PDF.js text layer and viewer */
        .pdfViewer {
            width: 100%;
            height: 100%;
            overflow-y: auto;
            background: #f0f0f5;
        }

        .page {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            margin: 10px auto;
            position: relative;
            background-color: white;
            border-radius: 6px;
        }

        /* PDF.js Text Layer styling is crucial for selection */
        .textLayer {
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            color: transparent; /* Makes text invisible, but selectable */
            overflow: hidden;
            line-height: 1.0; /* Must match the CSS used during PDF rendering */
            z-index: 10; /* Ensures it sits above the canvas */
        }

        .textLayer span {
            position: absolute;
            white-space: pre;
            cursor: text;
            transform-origin: 0% 0%;
        }
        
        /* The comment highlight style */
        .comment-highlight {
            background-color: #fcd34d; /* Amber-300 */
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.2s;
        }

        .comment-text {
            font-style: italic;
            color: #4b5563; /* Gray-600 */
            border-left: 3px solid #f59e0b; /* Amber-500 */
            padding-left: 10px;
            white-space: pre-wrap; /* Preserve formatting */
            font-size: 0.875rem; /* text-sm */
        }

        .reply-list li {
            font-size: 0.875rem;
            color: #374151; /* Gray-700 */
            padding-left: 8px;
            border-left: 2px solid #9ca3af; /* Gray-400 */
            margin-top: 4px;
        }

        /* Responsive layout tweaks */
        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <header class="bg-indigo-700 text-white shadow-lg p-4 sticky top-0 z-20">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">PDF Annotator</h1>
            <label for="pdf-file" class="cursor-pointer bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                Upload PDF
                <input type="file" id="pdf-file" accept="application/pdf" class="hidden" onchange="handleFileSelect(event)">
            </label>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 lg:p-6 h-[calc(100vh-6rem)] relative">
        
        <div id="loader" class="text-center p-8 text-gray-500 hidden">
            <svg class="animate-spin h-8 w-8 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-2">Loading PDF...</p>
        </div>

        <div id="app-container" class="main-grid grid lg:grid-cols-3 gap-6 h-full" style="display: none;">
            
            <!-- PDF Viewer Column (Left) -->
            <div class="lg:col-span-2 bg-white rounded-xl shadow-xl overflow-hidden">
                <div class="h-full pdfViewer" id="pdf-container">
                    <p class="text-center text-gray-400 p-20">Please upload a PDF file to begin.</p>
                </div>
            </div>

            <!-- Comments/Annotation Column (Right) -->
            <div class="lg:col-span-1 flex flex-col h-full">
                <div class="bg-white rounded-xl shadow-xl p-4 flex flex-col flex-grow">
                    
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h2 class="text-xl font-bold text-gray-700">Annotations List</h2>
                        <button id="export-all-btn" onclick="exportAllComments()" class="text-sm bg-green-500 hover:bg-green-600 text-white py-1 px-3 rounded-lg font-semibold transition duration-150 shadow-md disabled:opacity-50" disabled>
                            Export All
                        </button>
                    </div>
                    
                    <!-- Display Area for Saved Comments -->
                    <div id="comments-list" class="flex-grow overflow-y-auto space-y-4">
                        <p id="no-comments" class="text-gray-400 italic text-sm">No annotations added yet. Select text in the PDF to start annotating.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Floating Action Menu for Annotation -->
        <div id="floating-menu" class="fixed hidden bg-indigo-600 shadow-xl rounded-lg p-1 z-30 transform -translate-x-1/2 -translate-y-full" style="position: absolute; top:0; left:0; pointer-events: none;">
            <button id="annotate-float-btn" onclick="triggerAnnotation()" class="text-white text-xs font-semibold py-1 px-3 rounded-md hover:bg-indigo-700 transition duration-150 flex items-center pointer-events-auto">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                Add Comment
            </button>
        </div>
    </main>
    
    <!-- Custom Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300">
            <h3 class="text-lg font-bold text-red-600 mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M8.257 3.341a1 1 0 00.894 0L14.78 6.57A1 1 0 0015 7.43v5.14a1 1 0 00-.22.61l-5.656 3.77A1 1 0 019 16.29V3.71a1 1 0 01.257-.37zM4.757 6.662a1 1 0 01.446.732l.006.183v5.14a1 1 0 01-.446.732l-3.224 2.149a.5.5 0 01-.75-.43v-5.14a1 1 0 01.446-.732l3.224-2.149z" clip-rule="evenodd" />
                </svg>
                Confirm Deletion
            </h3>
            <p id="modal-message" class="text-gray-700 mb-6">Are you sure you want to delete this item?</p>
            <div class="flex justify-end space-x-3">
                <button onclick="hideModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-semibold">Delete</button>
            </div>
        </div>
    </div>

    <!-- Load PDF.js Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        // Set up PDF.js worker path
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        let pdfDoc = null;
        let selectedText = "";
        let annotations = []; // Array to store all annotations and their replies

        const pdfContainer = document.getElementById('pdf-container');
        const commentsList = document.getElementById('comments-list');
        const floatingMenu = document.getElementById('floating-menu');
        const loader = document.getElementById('loader');
        const appContainer = document.getElementById('app-container');
        const exportAllBtn = document.getElementById('export-all-btn');

        // --- Confirmation Modal Functions (Replaces alert/confirm) ---
        let modalCallback = null;

        function showModal(message, callback) {
            document.getElementById('modal-message').textContent = message;
            modalCallback = callback;
            document.getElementById('modal-confirm-btn').onclick = () => {
                if (modalCallback) {
                    modalCallback();
                }
                hideModal();
            };
            document.getElementById('confirmation-modal').classList.remove('hidden');
        }

        function hideModal() {
            document.getElementById('confirmation-modal').classList.add('hidden');
            modalCallback = null;
        }

        // --- Utility Functions ---

        /**
         * Safely escapes text for use in HTML attributes (like onclick strings).
         * @param {string} text 
         * @returns {string} Escaped text.
         */
        function escapeForOnclick(text) {
            return text.replace(/\\/g, '\\\\')
                       .replace(/'/g, '\\\'')
                       .replace(/"/g, '\\\"');
        }
        
        /**
         * Copies text to the clipboard using the synchronous execCommand method
         * for maximum compatibility within an iFrame environment.
         * @param {string} text 
         */
        function copyToClipboard(text) {
            const tempInput = document.createElement('textarea');
            tempInput.style.position = 'fixed';
            tempInput.style.opacity = '0';
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            
            try {
                const successful = document.execCommand('copy');
                const msg = successful ? 'successful' : 'unsuccessful';
                console.log('Copying text command was ' + msg);
            } catch (err) {
                console.error('Oops, unable to copy', err);
            }
            
            document.body.removeChild(tempInput);
        }

        /**
         * Calculates the viewport position of the current text selection.
         */
        function getSelectionPosition() {
            const selection = window.getSelection();
            if (!selection.rangeCount) return null;
            
            const range = selection.getRangeAt(0);
            const rect = range.getBoundingClientRect();

            return {
                left: rect.left + rect.width / 2, 
                top: rect.top - 10,
            };
        }

        // --- Core PDF Loading Functions ---

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            appContainer.style.display = 'grid';
            pdfContainer.innerHTML = '';
            loader.classList.remove('hidden');

            const fileReader = new FileReader();
            fileReader.onload = function () {
                const pdfData = new Uint8Array(this.result);
                renderPDF(pdfData);
            };
            fileReader.readAsArrayBuffer(file);
        }

        async function renderPDF(pdfData) {
            try {
                pdfDoc = await pdfjsLib.getDocument({ data: pdfData }).promise;
                const numPages = pdfDoc.numPages;
                
                for (let i = 1; i <= numPages; i++) {
                    await renderPage(pdfDoc, i);
                }
                loader.classList.add('hidden');
                
                document.removeEventListener('mouseup', handleTextSelection); 
                document.addEventListener('mouseup', handleTextSelection);

                document.removeEventListener('mousedown', checkHideFloatingMenu);
                document.addEventListener('mousedown', checkHideFloatingMenu);

            } catch (error) {
                console.error('Error rendering PDF:', error);
                loader.classList.add('hidden');
                pdfContainer.innerHTML = '<p class="text-center text-red-500 p-10">Error loading PDF. Check console for details.</p>';
            }
        }

        async function renderPage(pdfDoc, num) {
            const page = await pdfDoc.getPage(num);
            const scale = 1.5;
            const viewport = page.getViewport({ scale: scale });

            const pageWrapper = document.createElement('div');
            pageWrapper.className = 'page relative mx-auto my-4';
            pageWrapper.style.width = `${viewport.width}px`;
            pageWrapper.style.height = `${viewport.height}px`;
            
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            pageWrapper.appendChild(canvas);

            const textLayerDiv = document.createElement('div');
            textLayerDiv.className = 'textLayer absolute top-0 left-0 w-full h-full';
            pageWrapper.appendChild(textLayerDiv);

            pdfContainer.appendChild(pageWrapper);

            await page.render({ canvasContext: context, viewport: viewport }).promise;

            const textContent = await page.getTextContent();
            
            pdfjsLib.renderTextLayer({
                textContent: textContent,
                container: textLayerDiv,
                viewport: viewport,
                textDivs: [],
            });
        }

        // --- Annotation and Interaction Functions ---

        /**
         * Renders the annotations array to the DOM.
         */
        function renderAnnotations() {
            commentsList.innerHTML = '';
            
            if (annotations.length === 0) {
                commentsList.innerHTML = '<p id="no-comments" class="text-gray-400 italic text-sm">No annotations added yet. Select text in the PDF to start annotating.</p>';
                exportAllBtn.disabled = true;
                return;
            }

            exportAllBtn.disabled = false;
            
            // Render in reverse order (newest first)
            annotations.slice().reverse().forEach(ann => {
                const commentDiv = document.createElement('div');
                commentDiv.className = 'comment-highlight group'; 
                commentDiv.setAttribute('data-id', ann.id);

                const safeTextForDisplay = ann.text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                const safeTextForClipboard = escapeForOnclick(ann.text);
                
                // Build HTML for replies
                const replyListHtml = ann.replies.length > 0 ? 
                    `<p class="text-xs font-semibold mt-3 text-gray-700">Comments/Questions:</p>
                    <ul class="list-disc ml-4 mt-1 space-y-1 reply-list">
                        ${ann.replies.map((reply, index) => `
                            <li class="flex items-center justify-between group/reply text-gray-700 p-1 hover:bg-amber-100 rounded transition duration-100">
                                <span id="reply-text-${ann.id}-${index}" 
                                      ondblclick="startEditReply(event, ${ann.id}, ${index})"
                                      class="flex-grow cursor-pointer">${reply.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</span>
                                <button onclick="deleteReply(${ann.id}, ${index})" 
                                        class="ml-2 p-1 text-red-400 hover:text-red-600 opacity-0 group-hover/reply:opacity-100 transition-opacity" 
                                        title="Delete Reply">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </li>
                        `).join('')}
                    </ul>` : '';

                // HTML structure for a single annotation
                commentDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <p class="text-xs text-gray-500 font-mono">Annotated Text:</p>
                        <div class="flex space-x-2">
                            <button onclick="copyToClipboard('${safeTextForClipboard}')" 
                                    class="copy-btn text-xs text-indigo-500 hover:text-indigo-700 font-medium py-1 px-2 rounded transition duration-150">
                                Copy to Clipboard
                            </button>
                            <button onclick="deleteAnnotation(${ann.id})" 
                                    class="copy-btn text-xs text-red-500 hover:text-red-700 font-medium py-1 px-2 rounded transition duration-150">
                                Delete Annotation
                            </button>
                        </div>
                    </div>
                    <blockquote class="comment-text">${safeTextForDisplay}</blockquote>
                    
                    ${replyListHtml}

                    <div class="mt-4 pt-3 border-t border-amber-400">
                        <p class="text-xs font-semibold text-gray-600 mb-1">Add Reply/Note:</p>
                        <div class="flex space-x-2">
                            <input type="text" id="reply-input-${ann.id}" placeholder="Type your comment/question here..." 
                                class="flex-grow text-sm border border-gray-300 p-2 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            <button onclick="addReply(${ann.id})" class="bg-indigo-500 hover:bg-indigo-600 text-white text-sm py-2 px-3 rounded-lg font-semibold transition duration-150" title="Add Reply">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                                    <path fill-rule="evenodd" d="M3 5a2 2 0 012-2v.005L5 3h14l.005.005A2 2 0 0119 5v10a2 2 0 01-2 2H7a2 2 0 01-2-2v-3.001A2 2 0 013 12V5zm1.707.707l1.414 1.414L10 10.414l-4.828 4.828-1.414-1.414L7.586 10 3.707 6.121z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                `;

                commentsList.appendChild(commentDiv);
            });
        }

        /**
         * Deletes an entire annotation block.
         * @param {number} annotationId 
         */
        function deleteAnnotation(annotationId) {
            showModal('Are you sure you want to delete this entire annotation block and all its replies?', () => {
                annotations = annotations.filter(ann => ann.id !== annotationId);
                renderAnnotations();
            });
        }

        /**
         * Deletes a specific reply from an annotation.
         * @param {number} annotationId 
         * @param {number} replyIndex 
         */
        function deleteReply(annotationId, replyIndex) {
            const annotation = annotations.find(ann => ann.id === annotationId);
            if (annotation) {
                // Since this is a minor deletion and not the main block, we skip the modal for brevity
                annotation.replies.splice(replyIndex, 1);
                renderAnnotations();
            }
        }

        /**
         * Initiates editing for a specific reply text (triggered by double-click).
         * @param {Event} event 
         * @param {number} annotationId 
         * @param {number} replyIndex 
         */
        function startEditReply(event, annotationId, replyIndex) {
            const replySpan = document.getElementById(`reply-text-${annotationId}-${replyIndex}`);
            if (!replySpan || replySpan.querySelector('input')) return;

            const originalText = replySpan.textContent;
            
            // Remove the delete button temporarily during edit for cleaner UI
            const parentLi = replySpan.closest('li');
            const deleteButton = parentLi.querySelector('button[title="Delete Reply"]');
            if (deleteButton) deleteButton.style.display = 'none';

            replySpan.innerHTML = `
                <input type="text" value="${originalText.replace(/"/g, '&quot;')}" 
                       id="edit-input-${annotationId}-${replyIndex}" 
                       onblur="saveEditReply(event, ${annotationId}, ${replyIndex})"
                       onkeydown="handleEditKeydown(event, ${annotationId}, ${replyIndex})"
                       class="w-full text-sm border border-indigo-500 p-1 rounded-md focus:ring-indigo-500 focus:border-indigo-500" />
            `;
            
            const input = document.getElementById(`edit-input-${annotationId}-${replyIndex}`);
            input.focus();
        }

        /**
         * Handles Enter (save) and Esc (cancel) key presses during editing.
         * @param {Event} event 
         * @param {number} annotationId 
         * @param {number} replyIndex 
         */
        function handleEditKeydown(event, annotationId, replyIndex) {
            if (event.key === 'Enter') {
                event.preventDefault();
                saveEditReply(event, annotationId, replyIndex);
            } else if (event.key === 'Escape') {
                event.preventDefault();
                // Revert state (re-render)
                renderAnnotations();
            }
        }

        /**
         * Saves the edited reply text when Enter is pressed or input loses focus.
         * @param {Event} event 
         * @param {number} annotationId 
         * @param {number} replyIndex 
         */
        function saveEditReply(event, annotationId, replyIndex) {
            const input = event.target;
            const newText = input.value.trim();

            const annotation = annotations.find(ann => ann.id === annotationId);
            if (annotation) {
                if (newText) {
                    annotation.replies[replyIndex] = newText;
                } else {
                    // If text is empty, treat as deletion
                    annotation.replies.splice(replyIndex, 1);
                }
                renderAnnotations();
            }
        }


        function addReply(annotationId) {
            const replyInput = document.getElementById(`reply-input-${annotationId}`);
            const replyText = replyInput.value.trim();

            if (replyText) {
                const annotation = annotations.find(ann => ann.id === annotationId);
                if (annotation) {
                    annotation.replies.push(replyText);
                    replyInput.value = '';
                    renderAnnotations();
                }
            }
        }

        function checkHideFloatingMenu(event) {
            const isClickInsideMenu = floatingMenu.contains(event.target);
            if (!isClickInsideMenu) {
                floatingMenu.classList.add('hidden');
                window.getSelection().removeAllRanges();
            }
        }

        /**
         * Handles text selection, cleans up PDF line breaks/hyphens, 
         * calculates position, and displays the floating menu.
         */
        function handleTextSelection() {
            setTimeout(() => {
                const selection = window.getSelection();
                let rawText = selection.toString();

                // --- Text Cleanup Logic ---
                // 1. Remove hyphens followed immediately by a newline (fixes hyphenated words across lines, e.g., "prac-\ntice")
                let cleanedText = rawText.replace(/-\r?\n|\r/g, ''); 

                // 2. Replace all other remaining newlines and multiple spaces with a single space.
                cleanedText = cleanedText.replace(/\s+/g, ' '); 
                
                selectedText = cleanedText.trim();
                // --- End Text Cleanup Logic ---
                
                if (selectedText.length > 0) {
                    const position = getSelectionPosition();
                    if (position) {
                        floatingMenu.style.left = `${position.left}px`;
                        floatingMenu.style.top = `${position.top}px`;
                        floatingMenu.classList.remove('hidden');
                    }
                } else {
                    if (!floatingMenu.contains(document.activeElement)) {
                        floatingMenu.classList.add('hidden');
                    }
                }
            }, 100);
        }

        function triggerAnnotation() {
            if (selectedText) {
                const newAnnotation = {
                    id: Date.now(),
                    text: selectedText,
                    replies: []
                };
                annotations.push(newAnnotation);
                renderAnnotations();
                
                floatingMenu.classList.add('hidden');
                window.getSelection().removeAllRanges();
                selectedText = "";
            }
        }

        /**
         * Exports all annotations and their replies to the clipboard in a structured format.
         */
        function exportAllComments() {
            if (annotations.length === 0) return;

            let exportText = "";
            
            // Loop through annotations in the order they were added (oldest first)
            // Note: annotations array stores data oldest first, but the rendering is reversed.
            annotations.forEach((ann, index) => {
                const quoteText = ann.text.trim();
                const quoteReplies = ann.replies;
                
                // Format the main quote block
                exportText += `${index + 1}) Annotated Text:\n${quoteText}`;
                
                // Add replies if they exist
                if (quoteReplies.length > 0) {
                    exportText += "\nComments/Questions:\n";
                    quoteReplies.forEach(reply => {
                        exportText += `- ${reply}\n`;
                    });
                }
                
                if (index < annotations.length - 1) {
                    exportText += "\n\n";
                }
            });

            copyToClipboard(exportText);
            console.log("All comments exported to clipboard.");
        }
    </script>
</body>
</html>